const fetch = require('node-fetch');
module.exports = async (req,res)=>{ if(req.method!=='POST') return res.status(405).send('Method Not Allowed'); const {plan='light',name='あなた',birth='1990-01-01'}=req.body||{}; const OPENAI_API_KEY=process.env.OPENAI_API_KEY; const MODEL=process.env.OPENAI_MODEL||'gpt-4o-mini'; if(!OPENAI_API_KEY) return res.status(500).json({error:'OPENAI_API_KEY not configured'}); const system = `あなたはルナ・セラフィナという案内人です。慈愛深く神秘的で分かりやすく書いてください。`; const templates={light:`ライト（約1000字）: 名前:${name} 生年月日:${birth}。タロット2枚（現在・課題）、ライフパス中心の資質解説、玄関/寝室の風水アドバイス、行動3つ。`, premium:`プレミアム（約1500字）: 名前:${name} 生年月日:${birth}。タロット3枚（過去/現在/未来）、マスター/カルマ反映、3か月カレンダー、具体的行動計画。`, platinum:`プラチナ（約2000字）: 名前:${name} 生年月日:${birth}。タロット5枚（過去/現在/未来/障害/最終）、3部構成（過去→現在→未来）、詳細な数秘解説、週次行動計画。`}; const userPrompt = templates[plan]||templates.light; try{ const r = await fetch('https://api.openai.com/v1/chat/completions',{method:'POST',headers:{'Content-Type':'application/json','Authorization':'Bearer '+OPENAI_API_KEY},body:JSON.stringify({model:MODEL,messages:[{role:'system',content:system},{role:'user',content:userPrompt}],temperature:0.9,max_tokens:2500})}); if(!r.ok){const txt=await r.text(); return res.status(500).json({error:'OpenAI error',detail:txt});} const j=await r.json(); const text=j.choices?.[0]?.message?.content||''; return res.status(200).json({text}); }catch(e){return res.status(500).json({error:String(e)});} };
