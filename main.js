function sumDigits(n){return n.toString().split("").reduce((a,b)=>a+Number(b),0)}function reduceKeepMasters(n){while(n>9&&!(n===11||n===22||n===33)){n=sumDigits(n)}return n}function lifePath(dateStr){const n=dateStr.replace(/-/g,"").split("").reduce((a,b)=>a+Number(b),0);return reduceKeepMasters(n)}function karmicDebt(dateStr){const debts=[13,14,16,19];const day=Number(dateStr.split("-")[2]||0);const month=Number(dateStr.split("-")[1]||0);const year=Number(dateStr.split("-")[0]||0);const candidates=[day,month,reduceKeepMasters(sumDigits(year)),reduceKeepMasters(sumDigits(day+month+year))];const hit=candidates.find(v=>debts.includes(v));return hit||null}
const vowels=new Set("AEIOUYaeiouy");function lettersToNumber(name){const map={A:1,B:2,C:3,D:4,E:5,F:6,G:7,H:8,I:9,J:1,K:2,L:3,M:4,N:5,O:6,P:7,Q:8,R:9,S:1,T:2,U:3,V:4,W:5,X:6,Y:7,Z:8};let sum=0;for(const ch of name.toUpperCase())if(map[ch])sum+=map[ch];return reduceKeepMasters(sum)}function heartNumber(name){const map={A:1,E:5,I:9,O:6,U:3,Y:7};let s=0;for(const ch of name.toUpperCase())if(map[ch]!==undefined)s+=map[ch];return reduceKeepMasters(s||0)}function personalityNumber(name){const all=lettersToNumber(name);const heart=heartNumber(name);return all===heart?reduceKeepMasters(all+4):reduceKeepMasters(Math.abs(all-heart)||2)}
const meanings={1:`私が見るのは、あなたの芯に灯る「開拓」の炎。小さな決断を先に置くほど、世界はあなたの味方になる。迷ったら“先に動く”が合図。`,2:`あなたの鍵は「共鳴」。人の気配を敏感に捉える力があるから、橋渡し役で運が開く。急がず、息を合わせるほど追い風に。`,3:`「表現」があなたの浄化。言葉・デザイン・音…外へ出すほど運が澄む。遊び心を予定に入れると、不思議と良縁が巡る。`,4:`堅実の星。仕組み化と習慣づくりが幸運の呼び水。今日は“5分だけ”の積み重ねを。安定が、次の飛躍台になります。`,5:`変化の星。旅・学び・環境替えがスイッチ。固定観念を一つ手放すと、風が通って一気に展開。身軽さが味方です。`,6:`愛と整えの星。身近な人へ注ぐ思いやりが、巡り巡って大きなご縁に。住まいの小さな快適化が金運も動かす。`,7:`探求の星。静かに深く掘る時期ほど、直感が研ぎ澄まされる。デジタルを少し離れ、自然のリズムに合わせて。`,8:`結果の星。値付け・交渉・評価の見直しで収穫期。遠慮していた力を公にすると、正当な対価が流れ込みます。`,9:`浄化と完成。手放しが次の扉。感謝を言葉に出すほど、終わりが始まりへと変わる。優しく締めて、軽く進む。`,11:`霊感の回線が強いマスター。ひらめきが降りやすいので、朝のメモを習慣に。光を分かち合うほど道が拓ける。`,22:`現実化のマスター。大きな構想を地に降ろす力。仕組み・チーム・スケール感に挑むと、運命が背中を押す。`,33:`無条件の慈愛。場の空気を温めるだけで人が整う。自分のケアを先に置くほど、天からの助けが届きやすい。`};
function buildFreeMessage({name,lp,heart,perso,debt}){const base=meanings[lp]||"今は静かに整える流れ。";const spice=heart===lp?"心の願いと現実が重なりやすい時期です。":`内なる願いは「${heart}」、外への印象は「${perso}」。この差を意識すると一段と生きやすくなります。`;const karma=debt?`また、カルマ数「${debt}」が示す学びが今世のギフト。焦らず丁寧に向き合えば必ず昇華します。`:"";const hook="— 有料版では金運・恋愛・仕事・今後3か月の開運アクションを、あなた専用の言葉で深掘りします。";return `【${name}さんの魂コード：${lp}】\n`+base+spice+karma+hook}
function makeTweetUrl(t,u=""){return`https://twitter.com/intent/tweet?text=${encodeURIComponent(t)}&url=${encodeURIComponent(u)}`}
const REFERRAL_WHITELIST=["SOULCODE.creator","SOULCODE.VIP","MASA2025"];function hasReferralUnlock(code){if(!code)return false;return REFERRAL_WHITELIST.includes(code.trim())}
window.addEventListener("DOMContentLoaded",()=>{const nameEl=document.getElementById("name");const birthEl=document.getElementById("birth");const refEl=document.getElementById("ref");const btn=document.getElementById("startBtn");const result=document.getElementById("result");const xBtn=document.getElementById("shareX");const goPlans=document.getElementById("goPlans");const params=new URLSearchParams(location.search);const rc=params.get("referral");if(rc){refEl.value=rc}btn.addEventListener("click",()=>{const name=(nameEl.value||"あなた").trim();const birth=birthEl.value;if(!birth){alert("生年月日を入力してください");return}const lp=lifePath(birth);const heart=heartNumber(name);const perso=personalityNumber(name);const debt=karmicDebt(birth);const text=buildFreeMessage({name,lp,heart,perso,debt});result.textContent=text;const tweet=`#SOULCODE 無料診断\n${name}さんのライフパスは ${lp}。`;xBtn.href=makeTweetUrl(tweet,location.origin);const code=refEl.value.trim();if(hasReferralUnlock(code)){localStorage.setItem("SOULCODE_UNLOCK","1");goPlans.textContent="🔓 有料ページを開く（紹介コード認証）";goPlans.href="./paid.html?plan=premium&unlock=1"}else{localStorage.removeItem("SOULCODE_UNLOCK");goPlans.textContent="有料プランを見る";goPlans.href="./plans.html"}})});
